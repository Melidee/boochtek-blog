<!DOCTYPE html>

<html class="no-js" lang="en-US">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<link href="http://gmpg.org/xfn/11" rel="profile"/>
<script>(function(html){html.className = html.className.replace(/\bno-js\b/,'js')})(document.documentElement);</script>
<title>Ruby on Rails – BoochTek, LLC</title>
<link href="//fonts.googleapis.com" rel="dns-prefetch"/>
<link href="//s.w.org" rel="dns-prefetch"/>
<link href="../../../feed" rel="alternate" title="BoochTek, LLC » Feed" type="application/rss+xml">
<link href="../../../comments/feed" rel="alternate" title="BoochTek, LLC » Comments Feed" type="application/rss+xml"/>
<link href="../../../category/webdev/rails/feed" rel="alternate" title="BoochTek, LLC » Ruby on Rails Category Feed" type="application/rss+xml"/>
<script type="text/javascript">
			window._wpemojiSettings = {"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/2.2.1\/72x72\/","ext":".png","svgUrl":"https:\/\/s.w.org\/images\/core\/emoji\/2.2.1\/svg\/","svgExt":".svg","source":{"concatemoji":"http:\/\/blog.boochtek.com\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.7.2"}};
			!function(a,b,c){function d(a){var b,c,d,e,f=String.fromCharCode;if(!k||!k.fillText)return!1;switch(k.clearRect(0,0,j.width,j.height),k.textBaseline="top",k.font="600 32px Arial",a){case"flag":return k.fillText(f(55356,56826,55356,56819),0,0),!(j.toDataURL().length<3e3)&&(k.clearRect(0,0,j.width,j.height),k.fillText(f(55356,57331,65039,8205,55356,57096),0,0),b=j.toDataURL(),k.clearRect(0,0,j.width,j.height),k.fillText(f(55356,57331,55356,57096),0,0),c=j.toDataURL(),b!==c);case"emoji4":return k.fillText(f(55357,56425,55356,57341,8205,55357,56507),0,0),d=j.toDataURL(),k.clearRect(0,0,j.width,j.height),k.fillText(f(55357,56425,55356,57341,55357,56507),0,0),e=j.toDataURL(),d!==e}return!1}function e(a){var c=b.createElement("script");c.src=a,c.defer=c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g,h,i,j=b.createElement("canvas"),k=j.getContext&&j.getContext("2d");for(i=Array("flag","emoji4"),c.supports={everything:!0,everythingExceptFlag:!0},h=0;h<i.length;h++)c.supports[i[h]]=d(i[h]),c.supports.everything=c.supports.everything&&c.supports[i[h]],"flag"!==i[h]&&(c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&c.supports[i[h]]);c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&!c.supports.flag,c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.everything||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);
		</script>
<style type="text/css">
img.wp-smiley,
img.emoji {
	display: inline !important;
	border: none !important;
	box-shadow: none !important;
	height: 1em !important;
	width: 1em !important;
	margin: 0 .07em !important;
	vertical-align: -0.1em !important;
	background: none !important;
	padding: 0 !important;
}
</style>
<link href="https://fonts.googleapis.com/css?family=Merriweather%3A400%2C700%2C900%2C400italic%2C700italic%2C900italic%7CMontserrat%3A400%2C700%7CInconsolata%3A400&amp;subset=latin%2Clatin-ext" id="twentysixteen-fonts-css" media="all" rel="stylesheet" type="text/css"/>
<link href="../../../wp-content/themes/twentysixteen/genericons/genericons.css?ver=3.4.1" id="genericons-css" media="all" rel="stylesheet" type="text/css"/>
<link href="../../../wp-content/themes/twentysixteen/style.css?ver=4.7.2" id="twentysixteen-style-css" media="all" rel="stylesheet" type="text/css"/>
<!--[if lt IE 10]>
<link rel='stylesheet' id='twentysixteen-ie-css'  href='http://blog.boochtek.com/wp-content/themes/twentysixteen/css/ie.css?ver=20150825' type='text/css' media='all' />
<![endif]-->
<!--[if lt IE 9]>
<link rel='stylesheet' id='twentysixteen-ie8-css'  href='http://blog.boochtek.com/wp-content/themes/twentysixteen/css/ie8.css?ver=20150825' type='text/css' media='all' />
<![endif]-->
<!--[if lt IE 8]>
<link rel='stylesheet' id='twentysixteen-ie7-css'  href='http://blog.boochtek.com/wp-content/themes/twentysixteen/css/ie7.css?ver=20150825' type='text/css' media='all' />
<![endif]-->
<!--[if lt IE 9]>
<script type='text/javascript' src='http://blog.boochtek.com/wp-content/themes/twentysixteen/js/html5.js?ver=3.7.3'></script>
<![endif]-->
<script src="../../../wp-includes/js/jquery/jquery.js?ver=1.12.4" type="text/javascript"></script>
<script src="../../../wp-includes/js/jquery/jquery-migrate.min.js?ver=1.4.1" type="text/javascript"></script>
<link href="../../../wp-json/" rel="https://api.w.org/"/>
<link href="../../../xmlrpc.php?rsd" rel="EditURI" title="RSD" type="application/rsd+xml"/>
<link href="../../../wp-includes/wlwmanifest.xml" rel="wlwmanifest" type="application/wlwmanifest+xml"/>
<meta content="WordPress 4.7.2" name="generator"/>
</link></head>
<body class="archive category category-rails category-6 hfeed">
<div class="site" id="page">
<div class="site-inner">
<a class="skip-link screen-reader-text" href="#content">Skip to content</a>
<header class="site-header" id="masthead" role="banner">
<div class="site-header-main">
<div class="site-branding">
<p class="site-title"><a href="../../" rel="home">BoochTek, LLC</a></p>
<p class="site-description">Web Development, Ruby on Rails, Open Source</p>
</div><!-- .site-branding -->
</div><!-- .site-header-main -->
</header><!-- .site-header -->
<div class="site-content" id="content">
<div class="content-area" id="primary">
<main class="site-main" id="main" role="main">
<header class="page-header">
<h1 class="page-title">Category: Ruby on Rails</h1> </header><!-- .page-header -->
<article class="post-245 post type-post status-publish format-standard hentry category-architecture category-ruby category-rails" id="post-245">
<header class="entry-header">
<h2 class="entry-title"><a href="../../2015/06/22/not-quite-callbacks" rel="bookmark">Not Quite Callbacks</a></h2> </header><!-- .entry-header -->
<div class="entry-content">
<p>I’ve been working on application architectures based on <a href="http://confreaks.tv/videos/rubymidwest2011-keynote-architecture-the-lost-years">Uncle Bob’s Ruby Midwest talk</a>, following the <a href="http://alistair.cockburn.us/Hexagonal+architecture">hexagonal architectural pattern</a>. I posted <a href="../../2015/02/23/hexagonal-rails-controllers">an article a couple months ago showing a way that works fairly well in Rails</a>, and some <a href="https://github.com/boochtek/hexagonal-rails">accompanying Rails example code</a>. But there was one thing I wasn’t quite happy with.</p>
<p>The problem is that we used callbacks (actually, a publish/subscribe mechanism) in a situation where they don’t seem to quite fit:</p>
<pre>  def show
    interactor.on(:display) { |order| render order }
    interactor.on(:not_found) { |order_id| render status: 404 }
    interactor.get(params[:id])
  end</pre>
<p>What we really want is to respond in different ways, depending on the result of the call to <code>interactor.get()</code>. There’s no good reason to define the responses before the call. It makes a lot more sense to define the responses after the call, because they’ll <strong>happen</strong> after the call. I’d much prefer that the code be written in the order that it will be run.</p>
<p>I discussed this problem with my friend and colleague, <a href="http://dirtyinformation.com/">Amos King</a>. We came up with a better solution, which puts things back in the right order:</p>
<pre>  def show
    interactor.get(params[:id]) do |on|
      on.display { |order| render order }
      on.not_found { |order_id| render status: 404 }
    end
  end</pre>
<p>He even wrote a small library to do this, which he called <a href="https://github.com/BinaryNoggin/riposte">Riposte</a>. I’m not sure what to call this pattern, but it seems to work pretty well in this situation. I suppose that they’re still technically callbacks, because they’re passed in in the block that’s passed in to the call to <code>interactor.get()</code>. But due to the magic of Ruby blocks, we get to put them in the order they should be.</p>
<p>Riposte also gives you the option of using the response object directly, instead of passing a block:</p>
<pre>  def show
    on = interactor.get(params[:id])
    on.display { |order| render order }
    on.not_found { |order_id| render status: 404 }
  end</pre>
<p>This shows that it’s just returning an object, with the twist that the response object has methods that take blocks. The nested blocks variant is really the same thing, except that it’s yielding to the response object instead of returning it.</p>
<p>I’ve decide that is the pattern I’d like to use for interactions and their callers within Ruby hexagonal architecture.</p>
</div><!-- .entry-content -->
<footer class="entry-footer">
<span class="byline"><span class="author vcard"><img alt="" class="avatar avatar-49 photo" height="49" src="http://2.gravatar.com/avatar/52bfd7cb9ac37808464919f9685ca62f?s=49&amp;d=blank&amp;r=g" srcset="http://2.gravatar.com/avatar/52bfd7cb9ac37808464919f9685ca62f?s=98&amp;d=blank&amp;r=g 2x" width="49"/><span class="screen-reader-text">Author </span> <a class="url fn n" href="../../author/booch">Craig Buchek</a></span></span><span class="posted-on"><span class="screen-reader-text">Posted on </span><a href="../../2015/06/22/not-quite-callbacks" rel="bookmark"><time class="entry-date published updated" datetime="2015-06-22T23:55:17+00:00">June 22, 2015</time></a></span><span class="cat-links"><span class="screen-reader-text">Categories </span><a href="../../category/programming/architecture" rel="category tag">Architecture</a>, <a href="../../category/programming/programming-languages/ruby" rel="category tag">Ruby</a>, <a href="../../category/webdev/rails" rel="category tag">Ruby on Rails</a></span><span class="comments-link"><a href="../../2015/06/22/not-quite-callbacks#respond">Leave a comment<span class="screen-reader-text"> on Not Quite Callbacks</span></a></span> </footer><!-- .entry-footer -->
</article><!-- #post-## -->
<article class="post-202 post type-post status-publish format-standard hentry category-oop category-ruby category-rails" id="post-202">
<header class="entry-header">
<h2 class="entry-title"><a href="../../2015/02/23/hexagonal-rails-controllers" rel="bookmark">Hexagonal Rails Controllers</a></h2> </header><!-- .entry-header -->
<div class="entry-content">
<p>I’ve had a long love-hate relationship with Rails. I love the MVC framework and how it’s improved our speed of writing web apps. But I’ve never really been completely happy with it. I don’t generally agree with most of its opinions. I prefer models that follow the Data Mapper pattern, not the Active Record pattern. This includes separating the persistence layer from the models’ business logic. I prefer Slim or HAML to ERB. I prefer RSpec to Test::Unit or MiniTest. When Merb hit the scene, I was ready to make the jump, until Merb merged with Rails.</p>
<p>So inspired by <a href="https://blog.engineyard.com/2015/life-beyond-rails-brief-look-alternate-web-frameworks-ruby">PJ Hagerty’s recent article on alternative Ruby web frameworks</a>, I started thinking about how I’d write a replacement for Rails. I’d definitely keep the basic MVC framework. But I’d also want to implement a more <a href="http://alistair.cockburn.us/Hexagonal+architecture">hexagonal architecture</a>.</p>
<p>I started sketching out what this would look like, but I ended up starting with a Rails controller and finding the simplest way to make it hexagonal. I really don’t like callbacks, because they make tracing program execution difficult. But I didn’t see any other alternative. I found a simple pub/sub Ruby library called Wisper. It literally has only <code>publish</code>, <code>subscribe</code>, and <code>on</code> methods. (You use <code>on</code> to register single callbacks via blocks, and <code>subscribe</code> to register an object with method names corresponding to the callback names.)</p>
<p>The trick was figuring out how to break the controller into 2 pieces. What finally helped me was to find the single responsibilities of the 2 pieces. The Rails controller would remain in charge of managing the web interface, but would delegate to the other piece to handle any application-specific business logic. I decided to re-watch <a href="http://confreaks.tv/videos/rubymidwest2011-keynote-architecture-the-lost-years">Uncle Bob Martin’s “Architecture The Lost Years” talk</a>, which was the first time I was introduced to the ideas of Hexagonal Architecture. (He doesn’t name the architecture in the talk, but later calls it Clean Architecture.) He does a decent job of explaining how to break these 2 pieces apart. He used the term “interactor” in that talk, so I decided to go with that. He said that Jacobsen calls it a Control Object in <a href="http://www.amazon.com/Object-Oriented-Software-Engineering-Approach/dp/0201544350">Object Oriented Software Engineering</a>, but that’s too close to Rails’s “controller”.</p>
<p>So here’s an example of what I ended up with:</p>
<pre>class OrderController &lt; ApplicationController
  def index
    interactor.on(:display) { |orders| render orders }
    interactor.list
  end

  def show
    interactor.on(:display) { |order| render order }
    interactor.on(:not_found) { |order_id| render status: 404 }
    interactor.get(params[:id])
  end

private

  def interactor
    @interactor ||= OrderInteractor.new
  end
end</pre>
<pre>require "wisper"
require "order"

class OrderInteractor
  include Wisper.publisher

  def list
    orders = Order.all
    publish(:display, orders)
  end

  def get(id)
    order = Order.find(id)
    publish(:display, order)
  rescue ActiveRecord::RecordNotFound
    publish(:not_found, id)
  end
end</pre>
<p>I do have a few problems with this solution though. I’m not a fan of the name “interactor” for the business logic. I thought about calling it <code>OrderOperator</code>, or maybe <code>OrderOperations</code>, because it’s really a collection of operations. Perhaps it would be better to separate each operation into a separate class. <a href="https://github.com/apotonick/trailblazer">Trailblazer</a> does it that way. And for more complicated business logic, I would do that too, using the Method Object pattern. But like a Rails controller, there’s a lot in common among all the operations. I feel like a separate class for each operation for each would create too many coupled classes.</p>
<p>I’m also uncomfortable with the fact that the controller is delegating almost everything to the interactor. I guess this is OK, but it feels like there’s too little left when every line starts with <code>interactor</code>. I suppose extracting things some more would help mitigate this concern I’ll likely write a small gem to perform that extraction. I expect that that will allow a typical controller to be written in only a few lines. And maybe the same for the interactor side.</p>
<p>With the business logic extracted out of the controller, it was really easy for me to write a command-line version of the app. As Uncle Bob says, “the web is not particularly important to your application.”</p>
<p>I’ve put the code for this example on GitHub: <a href="https://github.com/boochtek/hexagonal-rails">https://github.com/boochtek/hexagonal-rails</a>. I’ll likely experiment with it some more over the next few weeks and months.</p>
</div><!-- .entry-content -->
<footer class="entry-footer">
<span class="byline"><span class="author vcard"><img alt="" class="avatar avatar-49 photo" height="49" src="http://2.gravatar.com/avatar/52bfd7cb9ac37808464919f9685ca62f?s=49&amp;d=blank&amp;r=g" srcset="http://2.gravatar.com/avatar/52bfd7cb9ac37808464919f9685ca62f?s=98&amp;d=blank&amp;r=g 2x" width="49"/><span class="screen-reader-text">Author </span> <a class="url fn n" href="../../author/booch">Craig Buchek</a></span></span><span class="posted-on"><span class="screen-reader-text">Posted on </span><a href="../../2015/02/23/hexagonal-rails-controllers" rel="bookmark"><time class="entry-date published updated" datetime="2015-02-23T23:50:28+00:00">February 23, 2015</time></a></span><span class="cat-links"><span class="screen-reader-text">Categories </span><a href="../../category/programming/oop" rel="category tag">OOP</a>, <a href="../../category/programming/programming-languages/ruby" rel="category tag">Ruby</a>, <a href="../../category/webdev/rails" rel="category tag">Ruby on Rails</a></span><span class="comments-link"><a href="../../2015/02/23/hexagonal-rails-controllers#respond">Leave a comment<span class="screen-reader-text"> on Hexagonal Rails Controllers</span></a></span> </footer><!-- .entry-footer -->
</article><!-- #post-## -->
<article class="post-191 post type-post status-publish format-standard hentry category-agile category-rails category-tdd" id="post-191">
<header class="entry-header">
<h2 class="entry-title"><a href="../../2014/05/05/tdd-is-alive-and-well" rel="bookmark">TDD Is Alive And Well</a></h2> </header><!-- .entry-header -->
<div class="entry-content">
<p>I went to RailsConf this year, and the very first talk was a <a href="http://www.confreaks.com/videos/3315-railsconf-keynote-writing-software">keynote by</a> <a href="http://www.confreaks.com/videos/3315-railsconf-keynote-writing-software">David Heinemeier Hansson (DHH)</a>, the creator of Ruby on Rails. The TL;DR of his talk was “TDD rarely has value”. He followed up with a blog post the next day, titled “<a href="http://david.heinemeierhansson.com/2014/tdd-is-dead-long-live-testing.html">TDD is dead. Long live testing.</a>“, and <a href="http://david.heinemeierhansson.com/2014/test-induced-design-damage.html">2 more</a> <a href="http://david.heinemeierhansson.com/2014/slow-database-test-fallacy.html">posts</a>. I think this line of thought is terribly misguided, and causing more harm than good. This article is my response.</p>
<p>First, I would like to address the good points of the talk. He said that programming is pseudoscience, and that people want to tell us that there’s a secret to being a better programmer. But what it really takes is working hard — reading a lot of code, writing a lot of code, and rewriting a lot of code. He’s right. And I also agree with him that you should forget about patterns for a while when learning to code. Beginners try to throw patterns at a problem instead of letting the patterns emerge where they’re supposed to.</p>
<p>I don’t completely agree that programming is a pseudoscience. In some ways it is, but I think it’s more of a craft. It’s a craft, because there’s a lot of science involved, but there’s also an art to doing it well. And like any craft, you’re always working to get better. So to respond to DHH’s stance that “software is more like poetry than physics”, I think it falls<br/>
somewhere in between.</p>
<p>With regard to the software engineering practices we use, there really isn’t much science available, mostly because it’s a soft science. That is, it’s really hard to isolate a single variable when comparing code between projects. And nobody has the time or money to write the same code so many times that the differences would be statistically significant.</p>
<p>So we don’t have much science on TDD. But we do have some. Here’s a collection of several: <a href="http://biblio.gdinwiddie.com/biblio/StudiesOfTestDrivenDevelopment">StudiesOfTestDrivenDevelopment</a>. And here’s one that explicitly looks are the difference between test-first and test-last: <a href="http://digitalcommons.calpoly.edu/cgi/viewcontent.cgi?article=1027&amp;context=csse_fac">Does Test-Driven Development Really Improve Software Design Quality?</a> What do these tell us? They tell us that TDD costs us about 10-30% in short-term productivity; reduces bugs by 30-90%, and decreases code complexity by about 30%. As <a href="http://www.cc2e.com/Default.aspx">Code Complete</a> tells us (in section 20.5, with studies to back it up), improving quality reduces development costs. So, like most Agile practices, this is a case where spending a bit more time in the short term leads to time savings in the long term.</p>
<p>The more important lesson in the talk was that you have to do what works best for you and your situation. If TDD doesn’t give better results, then either find out how to make it give better results, or stop using it. As we often say in the Agile world, Agile doesn’t mean that you can stop using your brain. While I think TDD is appropriate in most situations, there are cases where it’s not worth the additional up-front cost. If the most important thing for your project is time-to-market, then not testing might be the right decision for you.</p>
<p>To me, TDD provides a bunch of benefits. First and foremost, TDD is a design discipline. It ensures that I think about how my code will be used before I think about how to implement it. This is very powerful in ensuring that the code is well-written from the perspective of other code using it.</p>
<p>Tested code provides confidence to be able to make changes without breaking things. If we write tests after the code, we’re less likely to write them. Tests written after the code also tend to test the implementation instead of the desired functionality. What we really want is tests written as a specification. With tests as a specification, we can come back later and understand why code was written. Without tests, or with poor tests, we can’t understand why the code is there; if we want to rewrite it, we don’t have the confidence that we’re not missing something. Writing tests first also ensures that we only write the code that is needed to implement the required functionality.</p>
<p>I’m not sure why DHH hasn’t “gotten” TDD. I’m not sure if it’s because he’s  a better coder than average, or if he just thinks in a different way than most of us. I think it’s partly because he doesn’t understand TDD, which he admitted might be the case. And I think he’s conflating TDD and unit testing.</p>
<p>DHH is influential in the developer community, especially those newer to Ruby and Rails. People listen to what he has to say. I was happy to see almost every other speaker made fun of DHH’s ideas, and most of the crowd knew better. But there will be a lot of others who will hear DHH, respect his opinions, and not give TDD the try that it deserves. And that’s sad, because it will lead to an overall reduction in code quality in the world.</p>
<p>Here are some other people’s thoughts on the matter:</p>
<ul>
<li><a href="http://blog.8thlight.com/uncle-bob/2014/04/25/MonogamousTDD.html">Monogamous TDD</a> by Uncle Bob Martin</li>
<li><a href="http://blog.8thlight.com/uncle-bob/2014/04/30/When-tdd-does-not-work.html">When TDD doesn’t work</a> by Uncle Bob Martin</li>
<li><a href="https://www.facebook.com/notes/kent-beck/rip-tdd/750840194948847">RIP TDD</a> by Kent Beck</li>
<li><a href="http://codon.com/how-testability-can-help">How testability can help</a> by Tom Stuart</li>
<li><a href="http://www.thisagilelife.com/47/">This Agile Life Episode 47</a> (including myself)</li>
</ul>
<p> </p>
</div><!-- .entry-content -->
<footer class="entry-footer">
<span class="byline"><span class="author vcard"><img alt="" class="avatar avatar-49 photo" height="49" src="http://2.gravatar.com/avatar/52bfd7cb9ac37808464919f9685ca62f?s=49&amp;d=blank&amp;r=g" srcset="http://2.gravatar.com/avatar/52bfd7cb9ac37808464919f9685ca62f?s=98&amp;d=blank&amp;r=g 2x" width="49"/><span class="screen-reader-text">Author </span> <a class="url fn n" href="../../author/booch">Craig Buchek</a></span></span><span class="posted-on"><span class="screen-reader-text">Posted on </span><a href="../../2014/05/05/tdd-is-alive-and-well" rel="bookmark"><time class="entry-date published" datetime="2014-05-05T23:50:07+00:00">May 5, 2014</time><time class="updated" datetime="2014-05-27T22:36:25+00:00">May 27, 2014</time></a></span><span class="cat-links"><span class="screen-reader-text">Categories </span><a href="../../category/agile" rel="category tag">Agile</a>, <a href="../../category/webdev/rails" rel="category tag">Ruby on Rails</a>, <a href="../../category/agile/tdd" rel="category tag">TDD</a></span><span class="comments-link"><a href="../../2014/05/05/tdd-is-alive-and-well#comments">2 Comments<span class="screen-reader-text"> on TDD Is Alive And Well</span></a></span> </footer><!-- .entry-footer -->
</article><!-- #post-## -->
<article class="post-104 post type-post status-publish format-standard hentry category-oop category-ruby category-rails" id="post-104">
<header class="entry-header">
<h2 class="entry-title"><a href="../../2014/02/10/includable-activerecord" rel="bookmark">Includable ActiveRecord</a></h2> </header><!-- .entry-header -->
<div class="entry-content">
<p>I created a Ruby gem recently, called <a href="https://github.com/boochtek/includable-activerecord">includable-activerecord</a>. It’s pretty small, but I thought I might explain why I created it, and discuss its implementation.</p>
<h1>Classical Inheritance</h1>
<p>When you use ActiveRecord, you normally include it in your model like this:</p>
<pre>class User &lt; ActiveRecord::Base
  # ...
end</pre>
<p>Your <code>User</code> class is inheriting from the <code>ActiveRecord::Base</code> class. This is class-based inheritance, also called “classical” inheritance. (That’s “classical” as in “class”, not as a synonym for “traditional”.) Class-based inheritance represents an “is-a” relationship. So we’re saying that a user is an ActiveRecord base. Another way to say this is that <code>User</code> is a subclass of <code>ActiveRecord::Base.<br/>
</code><br/>
There are a few problems with this. First, what is a “base”? The name was chosen because it’s a base class. But just like we don’t give factory classes names like <code>UserFactory</code> (at least not in Ruby), we shouldn’t name base classes <code>Base</code>.</p>
<p>I suppose that we’re trying to say that this is an ActiveRecord model. That sounds fine at first glance — this is our model for users. But what if we also want to say that a user is a person? Ruby doesn’t allow inheriting from multiple classes. Now we have to choose whether to inherit from <code>ActiveRecord::Base</code> or <code>Person</code>. <code>Person</code> makes more sense, because it fills the “is-a” rule better. Class inheritance is intended for a hierarchical “is-a” relationship, such as “a user is a person”, or “a circle is a shape”. But since <code>ActiveRecord::Base</code> is a base class, we <strong>have</strong> to use it as our base class.</p>
<p>We could work around this problem by subclassing <code>Person</code> from <code>ActiveRecord::Base</code> and then subclassing <code>User</code> from <code>Person</code>. That’s fine if <code>Person</code> is also a model that we store in the database. But if that’s not the case, then we have a problem.</p>
<p><span style="color: #000000; font-weight: bold;">Mixins</span></p>
<p>Ruby provides another way of implementing inheritance — mixins. We often don’t think of this as an inheritance model, but it really is. When we include a module, that module gets added to the class’s ancestor chain. We can mix in as many modules as we want.</p>
<p>Mixins indicate more of an “acts like” relationship than an “is-a” relationship. It’s for shared behavior between classes that don’t have a hierarchical relationship. For example, when we mix in the <code>Enumerable</code> module, we’re saying that we want our class to act like other classes that include <code>Enumerable</code>. That sounds more like what we want ActiveRecord to be. We want our user model to behave like other ActiveRecord models, in the way that they can persist to a database.</p>
<p>But ActiveRecord doesn’t support that. Almost all the other Ruby ORMs do; as we’ve shown above, this is for good reasons.</p>
<h1>Implementation</h1>
<p>So I decided to see if I could implement the equivalent of the <code>ActiveRecord::Base</code> class as a module that could be mixed into model classes. I decided to call my mixin module <code>ActiveRecord::Model</code>, because classes that mix it in will behave as ActiveRecord models.</p>
<p>It turns out that <code>ActiveRecord::Base</code> is a pretty complex class. It includes and extends a lot of other modules. Luckily, as of ActiveRecord 4.0, that’s <strong>all</strong> the code it includes.</p>
<p>The module only defines a single class method, <a href="http://www.ruby-doc.org/core-2.0.0/Module.html#method-i-included"><code>included</code></a>. This is one of <a href="http://stackoverflow.com/questions/5127819/is-this-a-comprehensive-list-of-ruby-hook-methods">Ruby’s many hook methods</a>. It gets called when the module in question gets included in another module, and receives that other model as its argument. All we need to have this method do is to <code style="font-style: inherit;">include</code> everything that <code style="font-style: inherit;">ActiveRecord::Base</code> includes, and <code style="font-style: inherit;">extend</code> everything that <code style="font-style: inherit;">ActiveRecord::Base</code> extends. Ruby provides a method that’s defined on all classes, called <code style="font-style: inherit;">included_modules</code>, which we can use to get the list of everything that’s included in <code style="font-style: inherit;">ActiveRecord::Base</code>. Unfortunately, there’s no equivalent list of <code style="font-style: inherit;">extended_modules</code>. But a quick search on Stack Overflow found <a href="http://stackoverflow.com/a/5197277">an implementation of <code>extended_modules</code></a> that we could use.</p>
<p>So with a bit of magic (i.e. hooks and meta-programming), we can get the lists of constituent modules from the <code>ActiveRecord::Base</code> class, and include them in our <code>ActiveRecord::Model</code> module.</p>
<p>So with all that, we can now include the <a href="https://github.com/boochtek/includable-activerecord">includable-activerecord</a> gem and mix it in, with all the advantages that provides:</p>
<pre>class User
  include ActiveRecord::Model
  # ...
end</pre>
<p>It was exciting to be able to make this work. Since I wrote it as a proof of concept, I haven’t written any tests yet. But it seems to be working just fine. The main thing I really need to look into is making sure that plugins that extend <code>ActiveRecord::Base</code> from their own code will still work. I’m pretty sure this will work out of the box, because the <code>ActiveRecord::Model.included</code> doesn’t run until the model class is loaded, and that happens after those plugins have initialized themselves.</p>
</div><!-- .entry-content -->
<footer class="entry-footer">
<span class="byline"><span class="author vcard"><img alt="" class="avatar avatar-49 photo" height="49" src="http://2.gravatar.com/avatar/52bfd7cb9ac37808464919f9685ca62f?s=49&amp;d=blank&amp;r=g" srcset="http://2.gravatar.com/avatar/52bfd7cb9ac37808464919f9685ca62f?s=98&amp;d=blank&amp;r=g 2x" width="49"/><span class="screen-reader-text">Author </span> <a class="url fn n" href="../../author/booch">Craig Buchek</a></span></span><span class="posted-on"><span class="screen-reader-text">Posted on </span><a href="../../2014/02/10/includable-activerecord" rel="bookmark"><time class="entry-date published" datetime="2014-02-10T12:09:53+00:00">February 10, 2014</time><time class="updated" datetime="2014-02-18T16:28:58+00:00">February 18, 2014</time></a></span><span class="cat-links"><span class="screen-reader-text">Categories </span><a href="../../category/programming/oop" rel="category tag">OOP</a>, <a href="../../category/programming/programming-languages/ruby" rel="category tag">Ruby</a>, <a href="../../category/webdev/rails" rel="category tag">Ruby on Rails</a></span><span class="comments-link"><a href="../../2014/02/10/includable-activerecord#respond">Leave a comment<span class="screen-reader-text"> on Includable ActiveRecord</span></a></span> </footer><!-- .entry-footer -->
</article><!-- #post-## -->
<article class="post-93 post type-post status-publish format-standard hentry category-oop category-rails category-tdd" id="post-93">
<header class="entry-header">
<h2 class="entry-title"><a href="../../2014/01/26/testing-rails-validators" rel="bookmark">Testing Rails Validators</a></h2> </header><!-- .entry-header -->
<div class="entry-content">
<p>It’s challenging to test Rails custom validators.</p>
<p>I recently had to write a validator to require that an entered date is before or after a specified date.</p>
<p>It didn’t seem like writing the validator would be too difficult – I’ve written custom validators before, and date comparisons aren’t all that tricky. But when it came time to write the tests, I ran into several issues. And since I always try to follow TDD / test-first, I was blocked before I even began.</p>
<p>The biggest issue was the <code>ActiveModel::EachValidator#validates_each</code> API. It’s definitely not a well-designed API. You write your validator as a subclass, overriding <code>validates_each</code>. The method takes a model object, the name of the attribute of the model being tested, and the value of that attribute. You can also get the options passed to the custom validator via the <code>options</code> method. To perform a validation, you have to update the model’s <code>errors</code> hash.</p>
<p>The big flaw in the API is that instead of returning a result, you have to update the model. This needlessly couples the model and the validator. And it violates the Single Responsibility Principle — it has to determine validity of the field, and it has to update the <code>errors</code> hash of the model. This is not conducive to testing. Testing this method requires testing that the side-effect has taken place in the collaborator (model), which means it’s not really a unit test any more.</p>
<p>So to make it easier to unit test the validator, I broke the coupling by breaking it into 2 pieces, one for each responsibility. I moved the responsibility for determining validity to a separate method, which I called <code>errors_for</code>. It returns a hash of the errors found. This simplified the <code>validates_each</code> method to simply take the result of <code>errors_for</code> and update the <code>errors</code> hash of the model:</p>
<pre>def validate_each(record, attribute_name, attribute_value)
  record.errors[attribute_name].concat(errors_for(attribute_value, options))
end</pre>
<p>This made it much easier to unit test the <code>errors_for</code> method. This method doesn’t even need to know about the model — only about the value of the attribute we’re trying to validate. We simply pass in the attribute’s value and the options.</p>
<p>So we could write the tests without even pulling in ActiveRecord or any models:</p>
<pre>describe DateValidator do
  let(:validator) { DateValidator.new(attributes: :attribute_name) }
  let(:errors) { validator.errors_for(attribute_value, validation_options) }

  describe 'when attribute value is NOT a valid date' do
    let(:attribute_value) { 'not a valid date' }
    it { errors.must_include 'is not a valid date' }
  end

  describe 'when attribute value IS a valid date' do
    let(:attribute_value) { Date.parse('2013-12-11') }
    it { errors.must_be :empty? }
  end
end</pre>
<p>And the <code>errors_for</code> method looked something like this:</p>
<pre>def errors_for(attribute_value, options)
  unless attribute_value.is_a?(Date)
    return [options.fetch(:message, "is not a valid date")]
  end
  []
end</pre>
<p>Integration testing can also be a bit of a challenge. I recommend following the example from <a href="http://stackoverflow.com/a/17739176">this Stack Overflow answer</a>. Basically, create a minimal model object that contains the field and the validation. Then test that the model behaves like you expect with different values and validations.</p>
</div><!-- .entry-content -->
<footer class="entry-footer">
<span class="byline"><span class="author vcard"><img alt="" class="avatar avatar-49 photo" height="49" src="http://2.gravatar.com/avatar/52bfd7cb9ac37808464919f9685ca62f?s=49&amp;d=blank&amp;r=g" srcset="http://2.gravatar.com/avatar/52bfd7cb9ac37808464919f9685ca62f?s=98&amp;d=blank&amp;r=g 2x" width="49"/><span class="screen-reader-text">Author </span> <a class="url fn n" href="../../author/booch">Craig Buchek</a></span></span><span class="posted-on"><span class="screen-reader-text">Posted on </span><a href="../../2014/01/26/testing-rails-validators" rel="bookmark"><time class="entry-date published updated" datetime="2014-01-26T23:27:07+00:00">January 26, 2014</time></a></span><span class="cat-links"><span class="screen-reader-text">Categories </span><a href="../../category/programming/oop" rel="category tag">OOP</a>, <a href="../../category/webdev/rails" rel="category tag">Ruby on Rails</a>, <a href="../../category/agile/tdd" rel="category tag">TDD</a></span><span class="comments-link"><a href="../../2014/01/26/testing-rails-validators#respond">Leave a comment<span class="screen-reader-text"> on Testing Rails Validators</span></a></span> </footer><!-- .entry-footer -->
</article><!-- #post-## -->
</main><!-- .site-main -->
</div><!-- .content-area -->
<aside class="sidebar widget-area" id="secondary" role="complementary">
<section class="widget widget_pages" id="pages-2"><h2 class="widget-title">Pages</h2> <ul>
<li class="page_item page-item-2"><a href="../../about">About</a></li>
</ul>
</section><section class="widget widget_categories" id="categories-4"><h2 class="widget-title">Categories</h2> <ul>
<li class="cat-item cat-item-17"><a href="../../category/agile">Agile</a>
</li>
<li class="cat-item cat-item-26"><a href="../../category/programming/architecture">Architecture</a>
</li>
<li class="cat-item cat-item-20"><a href="../../category/blogging">Blogging</a>
</li>
<li class="cat-item cat-item-25"><a href="../../category/programming/programming-languages/brilliant">Brilliant</a>
</li>
<li class="cat-item cat-item-30"><a href="../../category/agile/empathy">Empathy</a>
</li>
<li class="cat-item cat-item-27"><a href="../../category/agile/estimation-agile">Estimation</a>
</li>
<li class="cat-item cat-item-22"><a href="../../category/gadgets">Gadgets</a>
</li>
<li class="cat-item cat-item-7"><a href="../../category/open-source/linux">GNU/Linux</a>
</li>
<li class="cat-item cat-item-9"><a href="../../category/programming/programming-languages">Languages</a>
</li>
<li class="cat-item cat-item-19"><a href="../../category/programming/oop">OOP</a>
</li>
<li class="cat-item cat-item-5"><a href="../../category/open-source">Open Source</a>
</li>
<li class="cat-item cat-item-8"><a href="../../category/programming">Programming</a>
</li>
<li class="cat-item cat-item-16"><a href="../../category/programming/programming-languages/python">Python</a>
</li>
<li class="cat-item cat-item-29"><a href="../../category/resolutions">Resolutions</a>
</li>
<li class="cat-item cat-item-28"><a href="../../category/agile/retrospectives">Retrospectives</a>
</li>
<li class="cat-item cat-item-10"><a href="../../category/programming/programming-languages/ruby">Ruby</a>
</li>
<li class="cat-item cat-item-6 current-cat"><a href="../../category/webdev/rails">Ruby on Rails</a>
</li>
<li class="cat-item cat-item-12"><a href="../../category/security">Security</a>
</li>
<li class="cat-item cat-item-21"><a href="../../category/programming/programming-languages/shell">Shell</a>
</li>
<li class="cat-item cat-item-13"><a href="../../category/sysadmin">System Admin</a>
</li>
<li class="cat-item cat-item-18"><a href="../../category/agile/tdd">TDD</a>
</li>
<li class="cat-item cat-item-4 current-cat-parent current-cat-ancestor"><a href="../../category/webdev">Web Development</a>
</li>
</ul>
</section> </aside><!-- .sidebar .widget-area -->
</div><!-- .site-content -->
<footer class="site-footer" id="colophon" role="contentinfo">
<div class="site-info">
<span class="site-title"><a href="../../" rel="home">BoochTek, LLC</a></span>
<a href="https://wordpress.org/">Proudly powered by WordPress</a>
</div><!-- .site-info -->
</footer><!-- .site-footer -->
</div><!-- .site-inner -->
</div><!-- .site -->
<script src="../../../wp-content/themes/twentysixteen/js/skip-link-focus-fix.js?ver=20150825" type="text/javascript"></script>
<script type="text/javascript">
/* <![CDATA[ */
var screenReaderText = {"expand":"expand child menu","collapse":"collapse child menu"};
/* ]]> */
</script>
<script src="../../../wp-content/themes/twentysixteen/js/functions.js?ver=20150825" type="text/javascript"></script>
<script src="../../../wp-includes/js/wp-embed.min.js?ver=4.7.2" type="text/javascript"></script>
</body>
</html>
